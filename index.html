<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KIZUNA ç››å²¡å¸‚ç‰ˆï¼ˆç°¡æ˜“ãƒ¢ãƒƒã‚¯ï¼‰</title>
  <style>
    :root {
      --bg: #f5f6f8;
      --card: #ffffff;
      --text: #000000;
      --muted: #333333;
      --radius: 12px;
      --green: #1a5d3a;
      --blue: #1e4a7a;
      --gray: #2d3748;
      --shadow: 0 6px 18px rgba(0,0,0,0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Meiryo", "ãƒ¡ã‚¤ãƒªã‚ª", "Hiragino Kaku Gothic ProN", "ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ ProN W3", "Yu Gothic Medium", "æ¸¸ã‚´ã‚·ãƒƒã‚¯ Medium", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.7;
      display: flex;
      justify-content: center;
      font-size: 18px;
    }
    .app { width: 100%; max-width: 440px; padding: 16px 12px 28px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    h1 { font-size: 24px; margin: 0; font-weight: 700; color: #000000; }
    .pill { padding: 8px 12px; border-radius: 999px; background: #d0d5dc; color: #1a1a1a; font-size: 14px; font-weight: 600; }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px; margin-bottom: 14px; overflow: hidden; }
    label { font-size: 16px; color: #1a1a1a; margin-bottom: 6px; display: block; font-weight: 600; }
    select, button { width: 100%; padding: 12px 14px; border-radius: 10px; border: 2px solid #4a5568; font-size: 17px; background: #fff; color: #000000; font-weight: 500; }
    .btn { background: var(--blue); color: #fff; border: none; cursor: pointer; font-weight: 700; font-size: 18px; padding: 14px; }
    .btn.secondary { background: #e2e8f0; color: #000000; border: 2px solid #4a5568; font-size: 16px; font-weight: 600; }
    .btn:active { opacity: 0.85; }
    .dropdown { position: relative; }
    .dropdown-btn {
      width: 100%; padding: 12px 14px; border-radius: 10px; border: 2px solid #4a5568;
      font-size: 17px; background: #fff; color: #000000; text-align: left; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center; gap: 8px; font-weight: 500;
    }
    .dropdown-panel {
      position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 2px solid #4a5568;
      border-radius: 10px; box-shadow: var(--shadow); padding: 12px; margin-top: 6px; z-index: 5;
      display: none; max-height: 240px; overflow-y: auto;
    }
    .dropdown.open .dropdown-panel { display: block; }
    .dropdown-item { display: flex; align-items: center; gap: 10px; padding: 8px 4px; font-size: 16px; cursor: pointer; color: #000000; }
    .dropdown-item input { width: 20px; height: 20px; }
    .tabs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 14px; }
    .tab { padding: 12px 14px; border-radius: 12px; text-align: center; font-weight: 700; border: 2px solid #4a5568; background: #fff; cursor: pointer; font-size: 17px; color: #000000; }
    .tab.active { background: #000000; color: #fff; border-color: #000000; }
    .event { display: grid; gap: 8px; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 999px; font-size: 15px; color: #fff; font-weight: 700; }
    .badge.all { background: var(--green); }
    .badge.district { background: var(--blue); }
    .badge.block { background: var(--gray); }
    .event-title { font-size: 20px; font-weight: 700; margin: 0; color: #000000; }
    .meta { color: #1a1a1a; font-size: 16px; font-weight: 500; }
    .place { font-size: 16px; color: #1a1a1a; font-weight: 500; }
    .chips { display: flex; gap: 10px; flex-wrap: wrap; }
    .chip { padding: 8px 10px; border-radius: 10px; background: #e2e8f0; color: #1a1a1a; font-size: 14px; font-weight: 600; }
    .actions { display: flex; gap: 10px; margin-top: 4px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 10px; }
    .cal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 6px; width: 100%; box-sizing: border-box; }
    .cal-head .btn.secondary { padding: 6px 8px; font-size: 13px; width: 55px; flex-shrink: 0; white-space: nowrap; }
    .cal-head > div { font-size: 20px; font-weight: 700; color: #000000; text-align: center; line-height: 1.3; flex: 1 1 0; min-width: 0; overflow: hidden; }
    .month-year { display: flex; flex-direction: column; align-items: center; gap: 2px; min-width: 0; }
    .month-year .year { font-size: 16px; font-weight: 700; color: #000000; }
    .month-year .month { font-size: 20px; font-weight: 700; color: #000000; }
    .weekday { text-align: center; font-size: 15px; color: #1a1a1a; font-weight: 700; padding: 8px 0; }
    .day { min-height: 85px; padding: 6px 2px; border-radius: 10px; background: #fff; border: 2px solid #d0d5dc; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; gap: 4px; cursor: pointer; transition: background 0.2s; }
    .day:hover { background: #f0f4f8; }
    .day.selected { background: #e3f2fd; border-color: var(--blue); }
    .day.out { background: #f8f9fa; color: #9aa5b1; border-color: #e2e8f0; }
    .day-num { font-weight: 700; font-size: 18px; color: #000000; }
    .day.out .day-num { color: #9aa5b1; }
    .calendar-legend { text-align: center; font-size: 15px; color: #1a1a1a; font-weight: 600; margin-bottom: 10px; padding: 8px; background: #f0f4f8; border-radius: 8px; border: 1px solid #d0d5dc; }
    .calendar-legend span { margin: 0 10px; }
    .calendar-legend .legend-blue { color: var(--blue); font-weight: 700; }
    .calendar-legend .legend-red { color: #dc3545; font-weight: 700; }
    .day-event-counts { display: flex; flex-direction: column; align-items: center; gap: 2px; margin-top: 2px; }
    .event-count-blue { color: var(--blue); font-size: 20px; font-weight: 700; line-height: 1.1; }
    .event-count-red { color: #dc3545; font-size: 20px; font-weight: 700; line-height: 1.1; }
    .day-events-list { margin-top: 12px; display: none; width: 100%; padding: 0 12px; }
    .day-events-list.show { display: block; }
    .day-events-list .event-card { background: #fff; border: 2px solid #4a5568; border-radius: 10px; padding: 12px; margin-bottom: 10px; }
    .day-events-list .event-title { font-size: 18px; font-weight: 700; color: #000000; margin: 0 0 6px 0; }
    .day-events-list .event-meta { font-size: 15px; color: #1a1a1a; margin: 4px 0; }
    .btn-register { background: var(--blue); color: #fff; border: none; cursor: pointer; font-weight: 700; font-size: 16px; padding: 10px 16px; border-radius: 8px; margin-top: 10px; width: 100%; }
    .btn-register.registered { background: #dc3545; }
    .btn-register:hover { opacity: 0.9; }
    .empty { text-align: center; color: #1a1a1a; padding: 20px 0; font-size: 17px; font-weight: 500; }
    .footer-note { text-align: center; color: #1a1a1a; font-size: 14px; margin-top: 12px; font-weight: 500; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>ç››å²¡å¸‚ã‚¤ãƒ™ãƒ³ãƒˆæ¡ˆå†…</h1>
      <span class="pill">ãƒ‡ãƒ¢è¡¨ç¤º</span>
    </header>

    <div class="tabs">
      <div class="tab active" data-tab="calendar">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
      <div class="tab" data-tab="list">ãƒªã‚¹ãƒˆ</div>
    </div>

    <section id="calendarView">
      <div class="card">
        <div class="cal-head">
          <button class="btn secondary" id="prevMonth">å‰æœˆ</button>
          <div id="monthLabel"></div>
          <button class="btn secondary" id="nextMonth">ç¿Œæœˆ</button>
        </div>
        <div id="calendarLegend" class="calendar-legend"></div>
        <div class="calendar" id="calendarGrid"></div>
      </div>
      <div id="dayEventsList" class="day-events-list"></div>
    </section>

    <section id="eventList" style="display:none;"></section>

    <section class="card">
      <div class="filter-grid">
        <div>
          <label>åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆä»»æ„ï¼‰</label>
          <select id="centerSelect">
            <option value="">æœªé¸æŠ</option>
            <option value="ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ–åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼">ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ–åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼</option>
          </select>
        </div>
        <div>
          <label>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ¨é€²åœ°åŒºï¼ˆå¿…é ˆï¼‰</label>
          <select id="districtSelect">
            <option value="ä»™åŒ—">ä»™åŒ—</option>
            <option value="æœ¬å®®">æœ¬å®®</option>
            <option value="å¤ªç”°">å¤ªç”°</option>
            <option value="ã¤ãªã">ã¤ãªã</option>
          </select>
        </div>
        <div id="blockSelectContainer">
          <label>ç”ºåï¼ˆè¤‡æ•°å¯ï¼‰</label>
          <div class="dropdown" id="blockDropdown">
            <button type="button" class="dropdown-btn" id="blockDropdownBtn">
              <span id="blockSummary">å…¨é¸æŠ</span>
              <span aria-hidden="true">â–¼</span>
            </button>
            <div class="dropdown-panel" id="blockOptions"></div>
          </div>
          <small style="color:#1a1a1a;font-size:14px;font-weight:500;">æœ€ä¸Šæ®µã€Œå…¨é¸æŠã€ã§å½“è©²åœ°åŒºã®å…¨ç”ºåã‚’å¯¾è±¡</small>
        </div>
        <button class="btn" id="applyBtn">é©ç”¨</button>
      </div>
    </section>

    <div class="footer-note">ç”»é¢å¹…360-440pxæƒ³å®šï¼ˆAndroidã‚¹ãƒãƒ›ï¼‰</div>
  </div>

  <script>
    const centerSelect = document.getElementById("centerSelect");
    const districtSelect = document.getElementById("districtSelect");
    const blockSelectContainer = document.getElementById("blockSelectContainer");
    const blockDropdown = document.getElementById("blockDropdown");
    const blockDropdownBtn = document.getElementById("blockDropdownBtn");
    const blockOptions = document.getElementById("blockOptions");
    const blockSummary = document.getElementById("blockSummary");
    const applyBtn = document.getElementById("applyBtn");
    const tabs = document.querySelectorAll(".tab");
    const eventList = document.getElementById("eventList");
    const calendarView = document.getElementById("calendarView");
    const monthLabel = document.getElementById("monthLabel");
    const calendarGrid = document.getElementById("calendarGrid");
    const calendarLegend = document.getElementById("calendarLegend");
    const prevMonth = document.getElementById("prevMonth");
    const nextMonth = document.getElementById("nextMonth");
    const dayEventsList = document.getElementById("dayEventsList");
    let selectedDate = null;

    // ç››å²¡å¸‚å…¨30åœ°åŒº
    const ALL_DISTRICTS = [
      "è¥¿å¨å·", "æ¡œåŸ", "ä»ç‹", "ä¸Šç”°", "ç±³å†…", "å±±å²¸", "æ¾åœ’", "ç·‘ãƒ¶ä¸˜",
      "åŸå—", "ä¸­é‡", "ç°—å·", "åŠ è³€é‡", "æœé™µ", "å¤§æ…ˆå¯º", "é’å±±", "æ±å¨å·",
      "åœŸæ·µ", "åŒ—å¨å·", "ã¿ãŸã‘", "ä»™åŒ—", "æœ¬å®®", "å¤ªç”°", "ã¤ãªã", "è¦‹å‰",
      "ä¹™éƒ¨", "é£¯å²¡", "å·»å €å§«ç¥", "å¥½æ‘©", "æ¸‹æ°‘", "ç‰å±±è–®å·"
    ];

    const BLOCKS = {
      ä»™åŒ—: ["å…¨é¸æŠ","1 ä»™åŒ—ä¸€ä¸ç›®","2 ä»™åŒ—äºŒä¸ç›®","3 ä»™åŒ—ä¸‰ä¸ç›®","4 æ±ä»™åŒ—ä¸€ä¸ç›®","5 æ±ä»™åŒ—äºŒä¸ç›®","6 å—ä»™åŒ—ä¸€ä¸ç›®","7 å—ä»™åŒ—äºŒä¸ç›®","8 å—ä»™åŒ—ä¸‰ä¸ç›®","9 è¥¿ä»™åŒ—ä¸€ä¸ç›®","10 è¥¿ä»™åŒ—äºŒä¸ç›®"],
      æœ¬å®®: ["å…¨é¸æŠ","1 æœ¬å®®ä¸€ï½ä¸ƒä¸ç›®","2 å‘ä¸­é‡ä¸€ï½ä¸ƒä¸ç›®","3 æœ¬å®®å­—çŸ³ä»","4 æœ¬å®®å­—ä¸Šè¶Šå ´","5 æœ¬å®®å­—æ°´é–€","6 æœ¬å®®å­—å¤§æŸ³","7 æœ¬å®®å­—å°æ—","8 æœ¬å®®å­—æ—å´","9 æœ¬å®®å­—å¤§å®®","10 æœ¬å®®å­—ä¹…ä¿ç­‹","11 æœ¬å®®å­—å°å¹…","12 æœ¬å®®å­—é¬¼æŸ³","13 æœ¬å®®å­—é‡å¤","14 æœ¬å®®å­—æ¾å¹…","15 æœ¬å®®å­—å°æ¿å°ç€¬","16 æœ¬å®®å­—è›‡å±‹æ•·","17 å‘ä¸­é‡å­—ç´°è°·åœ°","18 å‘ä¸­é‡å­—é“æ˜","19 å‘ä¸­é‡å­—æ±é“æ˜","20 å‘ä¸­é‡å­—å¹…","21 å‘ä¸­é‡å­—é¶´å­","22 å‘ä¸­é‡å­—æ–°ç”°","23 å‘ä¸­é‡å­—çŸ³å·ç”º","24 ä¸‹é¹¿å¦»å­—é•·æŒ","25 ä¸‹é¹¿å¦»å­—è¾»å±‹æ•·","26 ä¸‹é¹¿å¦»å­—è¥¿ç”°","27 ä¸‹é¹¿å¦»å­—å‰ç”°","28 ä¸‹é¹¿å¦»å­—å—ç”°","29 ä¸‹é¹¿å¦»å­—ä¸‹é€š","30 ä¸‹é¹¿å¦»å­—åŒ—"],
      å¤ªç”°: ["å…¨é¸æŠ","1 çŒªå»å­—","2 ä¸Šé¹¿å¦»å­—","3 ä¸­å¤ªç”°å­—","4 ä¸‹å¤ªç”°å­—","5 ä¸Šå¤ªç”°å­—"],
      ã¤ãªã: ["å…¨é¸æŠ","1 ç¹‹å­—å ‚ã‚±æ²¢","2 ç¹‹å­—å°¾å…¥é‡","3 ç¹‹å­—å±±æ ¹","4 ç¹‹å­—åŒ—ãƒæµ¦","5 ç¹‹å­—åŒ—ä¹…ä¿","6 ç¹‹å­—ä¸‹çŒ¿ç”°","7 ç¹‹å­—é™¤ã‚­","8 ç¹‹å­—èªå†…æ²¢","9 ç¹‹å­—èˆ˜å¸‚","10 ç¹‹å­—å¡—æ²¢","11 ç¹‹å­—æ¹¯ãƒèˆ˜","12 ç¹‹å­—æ¸…æ°´ç«¯","13 ç¹‹å­—çŒ¿ç”°"],
    };

    let selectedBlocks = ["å…¨é¸æŠ"];
    let currentMonth = new Date(2025, 2, 1); // 2025-03 è¡¨ç¤ºï¼ˆãƒ‡ãƒ¢ç”¨ï¼‰

    // ã‚»ãƒ³ã‚¿ãƒ¼ã«ç´ã¥ãåœ°åŒºãƒãƒƒãƒ”ãƒ³ã‚°
    const CENTER_DISTRICTS = {
      "ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ–åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼": ["ä»™åŒ—", "æœ¬å®®", "å¤ªç”°", "ã¤ãªã"],
    };

    const updateDistrictOptions = () => {
      const center = centerSelect.value;
      districtSelect.innerHTML = "";
      
      if (!center) {
        // æœªé¸æŠã®å ´åˆï¼šå…¨30åœ°åŒºã‚’è¡¨ç¤º
        ALL_DISTRICTS.forEach((d) => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          districtSelect.appendChild(opt);
        });
        // ç”ºåé¸æŠã‚’éè¡¨ç¤º
        blockSelectContainer.style.display = "none";
      } else {
        // é¸æŠæ¸ˆã¿ã®å ´åˆï¼šãã®ã‚»ãƒ³ã‚¿ãƒ¼ã«ç´ã¥ãåœ°åŒºã®ã¿
        const districts = CENTER_DISTRICTS[center] || [];
        // ã€Œå…¨é¸æŠã€ã‚’æœ€åˆã«è¿½åŠ 
        const allOpt = document.createElement("option");
        allOpt.value = "å…¨é¸æŠ";
        allOpt.textContent = "å…¨é¸æŠ";
        districtSelect.appendChild(allOpt);
        // åœ°åŒºã‚’è¿½åŠ 
        districts.forEach((d) => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          districtSelect.appendChild(opt);
        });
        // åˆæœŸé¸æŠã‚’ã€Œå…¨é¸æŠã€ã«è¨­å®š
        districtSelect.selectedIndex = 0;
        // åˆæœŸé¸æŠãŒã€Œå…¨é¸æŠã€ã®å ´åˆã¯ç”ºåé¸æŠã‚’éè¡¨ç¤ºã€ãã‚Œä»¥å¤–ã¯è¡¨ç¤º
        if (districtSelect.value === "å…¨é¸æŠ") {
          blockSelectContainer.style.display = "none";
        } else {
          blockSelectContainer.style.display = "block";
          selectedBlocks = ["å…¨é¸æŠ"];
          renderBlockOptions();
        }
      }
    };

    const EVENTS = [
      { id: 1, title: "ä»™åŒ—ã„ãã„ãä½“æ“", center: "ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ–åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼", district: "ä»™åŒ—", blocks: ["å…¨é¸æŠ"], place: "ä»™åŒ—åœ°åŒºæ´»å‹•ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆä»®ï¼‰", date: "3/12(æ°´) 10:00-11:30", start: "2025-03-12", detail: "æ¤…å­ä½“æ“ã¨äº¤æµ" },
      { id: 2, title: "æœ¬å®®ã‚«ãƒ•ã‚§", center: "ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ–åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼", district: "æœ¬å®®", blocks: ["å…¨é¸æŠ"], place: "æœ¬å®®åœ°åŒºæ´»å‹•ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆä»®ï¼‰", date: "3/15(åœŸ) 14:00-15:30", start: "2025-03-15", detail: "ãŠèŒ¶ã¨ãƒŸãƒ‹è¬›è©±" },
      { id: 3, title: "å¤ªç”°ãƒ»å¥åº·è¬›è©±", center: "ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ–åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼", district: "å¤ªç”°", blocks: ["å…¨é¸æŠ"], place: "å¤ªç”°åœ°åŒºæ´»å‹•ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆä»®ï¼‰", date: "3/20(æœ¨) 13:30-15:00", start: "2025-03-20", detail: "è¡€åœ§ãƒ»æ „é¤Šã®ãƒŸãƒ‹è¬›è©±" },
      { id: 4, title: "ã¤ãªããƒ»ãŠèŒ¶ä¼š", center: "ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ–åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼", district: "ã¤ãªã", blocks: ["å…¨é¸æŠ"], place: "ã¤ãªãå…¬æ°‘é¤¨ï¼ˆä»®ï¼‰", date: "3/22(åœŸ) 13:00-14:30", start: "2025-03-22", detail: "èŒ¶è©±ä¼šã¨è»½ã„ä½“æ“" },
      { id: 5, title: "ä»™åŒ—ãƒŸãƒ‹äº¤æµ", center: "ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ–åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼", district: "ä»™åŒ—", blocks: ["1 ä»™åŒ—ä¸€ä¸ç›®","2 ä»™åŒ—äºŒä¸ç›®"], place: "ä»™åŒ—åœ°åŒºæ´»å‹•ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆä»®ï¼‰", date: "3/25(ç«) 10:00-11:00", start: "2025-03-25", detail: "å°‘äººæ•°ã®äº¤æµä¼š" },
      { id: 6, title: "ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ–åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼ å…¨ä½“äº¤æµä¼š", center: "ã‚¤ãƒ¼ãƒãƒˆãƒ¼ãƒ–åœ°åŸŸåŒ…æ‹¬æ”¯æ´ã‚»ãƒ³ã‚¿ãƒ¼", district: "å…¨åŸŸ", blocks: ["å…¨é¸æŠ"], place: "ä»™åŒ—åœ°åŒºæ´»å‹•ã‚»ãƒ³ã‚¿ãƒ¼", date: "3/28(é‡‘) 14:00-16:00", start: "2025-03-28", detail: "ä»™åŒ—ãƒ»æœ¬å®®ãƒ»å¤ªç”°ãƒ»ã¤ãªãã®4åœ°åŒºåˆåŒã®äº¤æµä¼š" },
    ];

    // å‚åŠ ç”³ã—è¾¼ã¿çŠ¶æ…‹ã‚’ç®¡ç†ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ã‚­ãƒ¼ã¨ã™ã‚‹ï¼‰
    let registrations = new Set(); // å‚åŠ ç”³ã—è¾¼ã¿æ¸ˆã¿ã®ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’ä¿æŒ

    const renderBlockOptions = () => {
      // ç”ºåé¸æŠãŒéè¡¨ç¤ºã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
      if (blockSelectContainer.style.display === "none") {
        return;
      }
      const district = districtSelect.value;
      if (!BLOCKS[district]) return;
      blockOptions.innerHTML = "";
      BLOCKS[district].forEach((b) => {
        const item = document.createElement("label");
        item.className = "dropdown-item";
        const input = document.createElement("input");
        input.type = "checkbox";
        input.value = b;
        input.checked = selectedBlocks.includes(b);
        input.addEventListener("change", () => toggleBlock(b));
        item.appendChild(input);
        item.appendChild(document.createTextNode(b));
        blockOptions.appendChild(item);
      });
      updateBlockSummary();
    };

    const toggleBlock = (value) => {
      if (value === "å…¨é¸æŠ") {
        selectedBlocks = ["å…¨é¸æŠ"];
      } else {
        selectedBlocks = selectedBlocks.filter((v) => v !== "å…¨é¸æŠ");
        if (selectedBlocks.includes(value)) {
          selectedBlocks = selectedBlocks.filter((v) => v !== value);
        } else {
          selectedBlocks.push(value);
        }
        if (!selectedBlocks.length) selectedBlocks = ["å…¨é¸æŠ"];
      }
      renderBlockOptions();
    };

    const updateBlockSummary = () => {
      if (selectedBlocks.includes("å…¨é¸æŠ")) {
        blockSummary.textContent = "å…¨é¸æŠ";
      } else if (selectedBlocks.length === 1) {
        blockSummary.textContent = selectedBlocks[0];
      } else {
        blockSummary.textContent = `${selectedBlocks[0]} ä»–${selectedBlocks.length - 1}`;
      }
    };

    const matchEvent = (ev, center, district, blocks) => {
      if (center && ev.center !== center) return false;
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãŒã€Œå…¨åŸŸã€å¯¾è±¡ã®å ´åˆ
      if (ev.district === "å…¨åŸŸ") {
        // åœ°åŒºãŒã€Œå…¨é¸æŠã€ã®å ´åˆã¯è¡¨ç¤º
        if (district === "å…¨é¸æŠ") return true;
        // ç‰¹å®šã®åœ°åŒºãŒé¸ã°ã‚Œã¦ã„ã‚‹å ´åˆã‚‚è¡¨ç¤ºï¼ˆå…¨åŸŸã‚¤ãƒ™ãƒ³ãƒˆãªã®ã§ï¼‰
        const centerDistricts = CENTER_DISTRICTS[center] || [];
        if (centerDistricts.includes(district)) return true;
        return false;
      }
      
      // åœ°åŒºãŒã€Œå…¨é¸æŠã€ã®å ´åˆã¯ã€ãã®ã‚»ãƒ³ã‚¿ãƒ¼ã®å…¨åœ°åŒºã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¯¾è±¡
      if (district === "å…¨é¸æŠ") {
        const centerDistricts = CENTER_DISTRICTS[center] || [];
        if (!centerDistricts.includes(ev.district)) return false;
      } else if (district && ev.district !== district) {
        return false;
      }
      
      // ã‚»ãƒ³ã‚¿ãƒ¼æœªé¸æŠã§ç”ºåé¸æŠãŒéè¡¨ç¤ºã®å ´åˆã¯ã€åœ°åŒºã®ã¿ã§ãƒãƒƒãƒ
      if (!center || !blockSelectContainer.style.display || blockSelectContainer.style.display === "none") {
        return true; // åœ°åŒºãŒä¸€è‡´ã—ã¦ã„ã‚Œã°OK
      }
      // ã‚»ãƒ³ã‚¿ãƒ¼é¸æŠæ¸ˆã¿ã®å ´åˆã¯ç”ºåã‚‚ãƒã‚§ãƒƒã‚¯
      if (blocks.includes("å…¨é¸æŠ")) return true;
      return ev.blocks.some((b) => blocks.includes(b) || b === "å…¨é¸æŠ");
    };

    const badgeInfo = (ev) => {
      if (ev.district === "å…¨åŸŸ") {
        return { cls: "all", label: "å…¨åŸŸ", icon: "ğŸŒ" };
      }
      return { cls: "district", label: ev.district, icon: "ğŸ“" };
    };

    const renderEvents = () => {
      const center = centerSelect.value;
      const district = districtSelect.value;
      eventList.innerHTML = "";
      const filtered = EVENTS.filter((ev) => matchEvent(ev, center, district, selectedBlocks));
      if (!filtered.length) {
        const empty = document.createElement("div");
        empty.className = "card empty";
        empty.textContent = "è©²å½“ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“";
        eventList.appendChild(empty);
        return;
      }
      filtered.forEach((ev, idx) => {
        const info = badgeInfo(ev);
        const isRegistered = registrations.has(ev.id);
        const card = document.createElement("div");
        card.className = "card event";
        card.innerHTML = `
          <div class="badge ${info.cls}">${info.icon} ${info.label}</div>
          <p class="event-title">${ev.title}</p>
          <div class="meta">${ev.date}</div>
          <div class="place">å ´æ‰€: ${ev.place}</div>
          <div class="chips">
            <span class="chip">#${idx + 1}</span>
            <span class="chip">${ev.center}</span>
          </div>
          <button class="btn-register ${isRegistered ? 'registered' : ''}" data-event-id="${ev.id}">
            ${isRegistered ? 'âœ“ å‚åŠ ç”³ã—è¾¼ã¿æ¸ˆã¿' : 'å‚åŠ ç”³ã—è¾¼ã¿'}
          </button>
        `;
        eventList.appendChild(card);
        
        // å‚åŠ ç”³ã—è¾¼ã¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const registerBtn = card.querySelector('.btn-register');
        registerBtn.addEventListener('click', () => {
          toggleRegistration(ev.id);
          renderEvents(); // ãƒªã‚¹ãƒˆã‚’å†æç”»
          renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚å†æç”»
        });
      });
    };

    const buildMonthDays = (baseDate) => {
      const year = baseDate.getFullYear();
      const month = baseDate.getMonth();
      const first = new Date(year, month, 1);
      const startDay = first.getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const prevMonthDays = new Date(year, month, 0).getDate();
      const cells = [];
      for (let i = startDay - 1; i >= 0; i--) cells.push({ date: new Date(year, month - 1, prevMonthDays - i), out: true });
      for (let d = 1; d <= daysInMonth; d++) cells.push({ date: new Date(year, month, d), out: false });
      while (cells.length < 42) {
        const nextDay = cells.length - (startDay + daysInMonth) + 1;
        cells.push({ date: new Date(year, month + 1, nextDay), out: true });
      }
      return cells;
    };

    const formatMonthLabel = (date) => {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      return `<div class="month-year"><div class="year">${year}å¹´</div><div class="month">${month}æœˆ</div></div>`;
    };
    
    // æ•°å­—ã‚’ä¸¸æ•°å­—ã«å¤‰æ›ï¼ˆ1-20ã¾ã§å¯¾å¿œï¼‰
    const toCircledNumber = (num) => {
      const circled = ['â‘ ', 'â‘¡', 'â‘¢', 'â‘£', 'â‘¤', 'â‘¥', 'â‘¦', 'â‘§', 'â‘¨', 'â‘©', 'â‘ª', 'â‘«', 'â‘¬', 'â‘­', 'â‘®', 'â‘¯', 'â‘°', 'â‘±', 'â‘²', 'â‘³'];
      if (num >= 1 && num <= 20) {
        return circled[num - 1];
      }
      return num.toString(); // 20ã‚’è¶…ãˆã‚‹å ´åˆã¯é€šå¸¸ã®æ•°å­—
    };

    const toggleRegistration = (eventId) => {
      if (registrations.has(eventId)) {
        registrations.delete(eventId);
      } else {
        registrations.add(eventId);
      }
      // é¸æŠä¸­ã®æ—¥ä»˜ãŒã‚ã‚Œã°ã€ãã®æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ã‚’å†è¡¨ç¤º
      if (selectedDate) {
        const center = centerSelect.value;
        const district = districtSelect.value;
        const filtered = EVENTS.filter((ev) => matchEvent(ev, center, district, selectedBlocks));
        const iso = selectedDate.toISOString().split("T")[0];
        const dayEvents = filtered.filter(ev => ev.start === iso);
        showDayEvents(selectedDate, dayEvents);
      }
    };

    const showDayEvents = (date, events) => {
      // æ—¢å­˜ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢
      dayEventsList.innerHTML = "";
      
      if (!events || events.length === 0) {
        dayEventsList.classList.remove("show");
        return;
      }
      
      const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
      const header = document.createElement("div");
      header.style.cssText = "font-size: 20px; font-weight: 700; color: #000000; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #4a5568;";
      header.textContent = dateStr;
      dayEventsList.appendChild(header);

      events.forEach((ev) => {
        const card = document.createElement("div");
        card.className = "event-card";
        const info = badgeInfo(ev);
        const isRegistered = registrations.has(ev.id);
        card.innerHTML = `
          <div class="badge ${info.cls}" style="margin-bottom: 8px;">${info.icon} ${info.label}</div>
          <div class="event-title">${ev.title}</div>
          <div class="event-meta">${ev.date}</div>
          <div class="event-meta">å ´æ‰€: ${ev.place}</div>
          ${ev.detail ? `<div class="event-meta" style="margin-top: 6px;">${ev.detail}</div>` : ""}
          <button class="btn-register ${isRegistered ? 'registered' : ''}" data-event-id="${ev.id}">
            ${isRegistered ? 'âœ“ å‚åŠ ç”³ã—è¾¼ã¿æ¸ˆã¿' : 'å‚åŠ ç”³ã—è¾¼ã¿'}
          </button>
        `;
        dayEventsList.appendChild(card);
        
        // å‚åŠ ç”³ã—è¾¼ã¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const registerBtn = card.querySelector('.btn-register');
        registerBtn.addEventListener('click', () => {
          toggleRegistration(ev.id);
          renderCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»
        });
      });
      
      // è¡¨ç¤ºã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      dayEventsList.classList.add("show");
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦è¡¨ç¤ºé ˜åŸŸã«æŒã£ã¦ãã‚‹
      setTimeout(() => {
        dayEventsList.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }, 100);
    };

    const renderCalendar = () => {
      const center = centerSelect.value;
      const district = districtSelect.value;
      const filtered = EVENTS.filter((ev) => matchEvent(ev, center, district, selectedBlocks));
      const byDay = filtered.reduce((acc, ev) => {
        acc[ev.start] = acc[ev.start] || [];
        acc[ev.start].push(ev);
        return acc;
      }, {});

      monthLabel.innerHTML = formatMonthLabel(currentMonth);
      calendarGrid.innerHTML = "";
      dayEventsList.classList.remove("show");
      selectedDate = null;

      // èª¬æ˜ã‚’è¿½åŠ 
      calendarLegend.innerHTML = '<span class="legend-blue">ä¸Šæ®µé’å­—=æ¡ˆå†…ä»¶æ•°</span><span class="legend-red">ä¸‹æ®µæ•°å­—=å‚åŠ äºˆå®š</span>ã§è¡¨ç¤º';

      ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].forEach((w) => {
        const wd = document.createElement("div");
        wd.className = "weekday";
        wd.textContent = w;
        calendarGrid.appendChild(wd);
      });

      const cells = buildMonthDays(currentMonth);
      cells.forEach((cell) => {
        const iso = cell.date.toISOString().split("T")[0];
        const dayDiv = document.createElement("div");
        const isSelected = selectedDate && selectedDate.toISOString().split("T")[0] === iso;
        dayDiv.className = `day${cell.out ? " out" : ""}${isSelected ? " selected" : ""}`;
        dayDiv.innerHTML = `<div class="day-num">${cell.date.getDate()}</div>`;
        
        if (!cell.out && byDay[iso] && byDay[iso].length > 0) {
          const dayEvents = byDay[iso];
          const totalCount = dayEvents.length;
          const registeredCount = dayEvents.filter(ev => registrations.has(ev.id)).length;
          
          const countsDiv = document.createElement("div");
          countsDiv.className = "day-event-counts";
          
          if (totalCount > 0) {
            const blueCount = document.createElement("div");
            blueCount.className = "event-count-blue";
            blueCount.textContent = toCircledNumber(totalCount);
            countsDiv.appendChild(blueCount);
          }
          
          if (registeredCount > 0) {
            const redCount = document.createElement("div");
            redCount.className = "event-count-red";
            redCount.textContent = toCircledNumber(registeredCount);
            countsDiv.appendChild(redCount);
          }
          
          dayDiv.appendChild(countsDiv);
        }
        
        if (!cell.out) {
          dayDiv.addEventListener("click", () => {
            // é¸æŠçŠ¶æ…‹ã®åˆ‡ã‚Šæ›¿ãˆ
            const prevSelected = document.querySelector(".day.selected");
            if (prevSelected) {
              prevSelected.classList.remove("selected");
            }
            
            if (isSelected) {
              // åŒã˜æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯é–‰ã˜ã‚‹
              selectedDate = null;
              dayEventsList.classList.remove("show");
              dayDiv.classList.remove("selected");
            } else {
              // æ–°ã—ã„æ—¥ä»˜ã‚’é¸æŠ
              selectedDate = new Date(cell.date);
              dayDiv.classList.add("selected");
              showDayEvents(cell.date, byDay[iso] || []);
            }
          });
        }
        
        calendarGrid.appendChild(dayDiv);
      });
    };

    centerSelect.addEventListener("change", () => {
      updateDistrictOptions();
      renderEvents();
      renderCalendar();
    });

    districtSelect.addEventListener("change", () => {
      const district = districtSelect.value;
      selectedBlocks = ["å…¨é¸æŠ"];
      // åœ°åŒºãŒã€Œå…¨é¸æŠã€ã®å ´åˆã¯ç”ºåé¸æŠã‚’éè¡¨ç¤º
      if (district === "å…¨é¸æŠ") {
        blockSelectContainer.style.display = "none";
      } else if (blockSelectContainer.style.display !== "none") {
        renderBlockOptions();
      }
    });

    applyBtn.addEventListener("click", () => {
      renderEvents();
      renderCalendar();
    });

    blockDropdownBtn.addEventListener("click", () => {
      blockDropdown.classList.toggle("open");
    });
    document.addEventListener("click", (e) => {
      if (!blockDropdown.contains(e.target)) blockDropdown.classList.remove("open");
    });

    prevMonth.addEventListener("click", () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
      renderCalendar();
    });
    nextMonth.addEventListener("click", () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
      renderCalendar();
    });

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        const target = tab.dataset.tab;
        if (target === "list") {
          eventList.style.display = "block";
          calendarView.style.display = "none";
          renderEvents();
        } else {
          eventList.style.display = "none";
          calendarView.style.display = "block";
          renderCalendar();
        }
      });
    });

    // åˆæœŸåŒ–
    updateDistrictOptions();
    renderBlockOptions();
    renderEvents();
    renderCalendar();
  </script>
</body>
</html>






